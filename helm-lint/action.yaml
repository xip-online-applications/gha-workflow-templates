name: 'Lint helm chart'
description: 'Lint a local helm chart.'
author: 'XIP Online Applications'

branding:
    icon: 'unlock'
    color: 'blue'

inputs:
    command:
        description: 'The command to trigger the deployment. You can use two replacements: {0} = environment, {1} = tag.'
        required: true
    environment:
        description: 'The environment to build the container for.'
        default: 'dev'
    tag:
        description: 'The tag to use during the deployment.'
        default: 'latest'
    helm-version:
        description: 'The helm version to install.'
        default: 'latest'
    git-crypt-key:
        description: 'The base64 encoded git-crypt decryption key'
        required: false

runs:
    using: 'composite'
    steps:
        -   name: Install packages
            shell: bash
            run: sudo apt update && sudo apt install -y jq

        -   name: Install helm
            uses: azure/setup-helm@v3
            with:
                version: ${{ inputs.helm-version }}
#                token: ${{ secrets.GITHUB_TOKEN }}

        -   name: Git-crypt unlock
            uses: xip-online-applications/gha-workflow-templates/git-crypt-unlock@main
            with:
                git-crypt-key: ${{ inputs.git-crypt-key }}

#        -   name: Decrypt with git-crypt
#            run: |
#                KEY=${{ secrets.git-crypt-key }}
#                if [ ! -z "$KEY" ]; then
#                    sudo apt update && sudo apt install -y git-crypt
#                    echo $KEY | base64 -d > /tmp/git-crypt.key
#                    git-crypt unlock /tmp/git-crypt.key
#                    rm /tmp/git-crypt.key
#                fi

        -   name: Lint helm chart
            shell: bash
            run: ${{ format(inputs.command, inputs.environment, inputs.tag) }}
